<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="与一群有趣的人，做一些有趣的事."><title>BookKeeper 集群搭建及使用 | Matt's Blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">BookKeeper 集群搭建及使用</h1><a id="logo" href="/.">Matt's Blog</a><p class="description">柳年思水</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">BookKeeper 集群搭建及使用</h1><div class="post-meta">Oct 19, 2018<span> | </span><span class="category"><a href="/categories/技术/">技术</a></span><span> | </span><span class="post-count">5,943</span><span> 字</span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Times</span></span></div><a data-disqus-identifier="2018/10/19/bk-cluster-install-and-use/" href="/2018/10/19/bk-cluster-install-and-use/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#BookKeeper-简介"><span class="toc-number">1.</span> <span class="toc-text">BookKeeper 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BookKeeper-集群搭建"><span class="toc-number">2.</span> <span class="toc-text">BookKeeper 集群搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#集群搭建前准备"><span class="toc-number">2.1.</span> <span class="toc-text">集群搭建前准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集群搭建"><span class="toc-number">2.2.</span> <span class="toc-text">集群搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Admin-REST-API"><span class="toc-number">2.3.</span> <span class="toc-text">Admin REST API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装时踩的坑"><span class="toc-number">2.4.</span> <span class="toc-text">安装时踩的坑</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#问题1：修改配置后重新启动失败"><span class="toc-number">2.4.1.</span> <span class="toc-text">问题1：修改配置后重新启动失败</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BookKeeper-API-使用"><span class="toc-number">3.</span> <span class="toc-text">BookKeeper API 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Ledger-API"><span class="toc-number">3.1.</span> <span class="toc-text">The Ledger API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#初始化-BookKeeper-Client"><span class="toc-number">3.1.1.</span> <span class="toc-text">初始化 BookKeeper Client</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#新建一个-Ledger"><span class="toc-number">3.1.2.</span> <span class="toc-text">新建一个 Ledger</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#向-Ledger-写入数据"><span class="toc-number">3.1.3.</span> <span class="toc-text">向 Ledger 写入数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#从-Ledger-读取数据"><span class="toc-number">3.1.4.</span> <span class="toc-text">从 Ledger 读取数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#删除-Ledger"><span class="toc-number">3.1.5.</span> <span class="toc-text">删除 Ledger</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Ledger-Advanced-API"><span class="toc-number">3.2.</span> <span class="toc-text">The Ledger Advanced API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#新建-Ledger"><span class="toc-number">3.2.1.</span> <span class="toc-text">新建 Ledger</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#向-Ledger-添加-Entry"><span class="toc-number">3.2.2.</span> <span class="toc-text">向 Ledger 添加 Entry</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><p>随着 Apache Pulsar 成为 Apache 的顶级开源项目，其存储层的解决方案 Apache BookKeeper 再次受到业界广泛关注。BookKeeper 在 Pulsar 之前也有很多成功的应用，比如使用 BookKeeper 实现了 HDFS NameNode 的 HA 机制（可能大部分公司使用的还是 Quorum Journal Manage 方案）、Twitter 开源的 DistributedLog 系统（可参考<a href="http://www.infoq.com/cn/news/2016/05/Twitter-Github-DistributedLog" target="_blank" rel="external">Twitter开源分布式高性能日志复制服务</a>），BookKeeper 作为一个高扩展、强容错、低延迟的存储服务（A scalable, fault-tolerant, and low-latency storage service optimized for real-time workloads），它相当于把底层的存储层系统服务化（BookKeeper 是更底层的存储服务，类似于 Kafka 的存储层）。这样可以使得依赖于 BookKeeper 实现的分布式存储系统（包括分布式消息队列）在设计时可以只关注其应用层和功能层的内容，存储层比较难解决的问题像一致性、容错等，BookKeeper 已经实现了，从这个层面看，BookKeeper 确实解决业内的一些问题，而且 BookKeeper （Ledger 化，Ledger 相当于 Kafka segment）天生适合云上部署，未来还是有很大潜力的。近段对 BookKeeper 做了一些相应的调研，做了一些总结，本文将会主要从集群部署和使用角度来介绍一下 Apache BookKeeper，后面准备再写一篇文章来深入讲述其架构设计及实现原理。</p>
<h2 id="BookKeeper-简介"><a href="#BookKeeper-简介" class="headerlink" title="BookKeeper 简介"></a>BookKeeper 简介</h2><p>这里先对 BookKeeper 的基本概念做一下介绍，下图是 BookKeeper 的架构图（图片来自 <a href="https://www.slideshare.net/streamlio/introduction-to-apache-bookkeeper-distributed-storage?qid=3cbd6bbf-9e04-4e38-9ab6-4619e4d8f61e&amp;v=&amp;b=&amp;from_search=1" target="_blank" rel="external">Introduction to Apache BookKeeper</a>）：</p>
<p><img src="/images/bookkeeper/bookkeeper.png" alt="Apache BookKeeper 架构图"></p>
<p>在 BookKeeper 中节点（Server）被称作 Bookie（类似于 Kafka 中 Broker，HDFS 中的 DN，但是 BookKeeper 没有 Master 节点，它是典型 Slave/Slave 架构），数据在 Bookie 上以 Ledger 的形式存储（类似 Kafka 中的 Segment，HDFS 中的 Block）， BookKeeper 相关的基本概念如下：</p>
<ol>
<li>Cluster: 所有的 Bookie 组成一个集群（连接到同一个 zk 地址的 Bookie 集合）；</li>
<li>Bookie：BookKeeper 的存储节点，也即 Server 节点；</li>
<li>Ledger：Ledger 是对一个 log 文件的抽象，它本质上是由一系列 Entry （类似与 Kafka 每条 msg）组成的，client 在向 BookKeeper 写数据时也是往 Ledger 中写的；</li>
<li>Entry：entry 本质上就是一条数据，它会有一个 id 做标识；</li>
<li>Journal: Write ahead log，数据是先写到 Journal 中，这个也是 BookKeeper 读写分离实现机制的一部分，后续会详细分析；</li>
<li>Ensemble: Set of Bookies across which a ledger is striped，一个 Ledger 所涉及的 Bookie 集合，初始化 Ledger 时，需要指定这个 Ledger 可以在几台 Bookie 上存储；</li>
<li>Write Quorum Size: Number of replicas，要写入的副本数；</li>
<li>Ack Quorum Size: Number of responses needed before client’s write is satisfied，当这么多副本写入成功后才会向 client 返回成功，比如副本数设置了 3，这个设置了2，client 会同时向三副本写入数据，当收到两个成功响应后，会认为数据已经写入成功；</li>
<li>LAC: Last Add Confirmed，Ledger 中已经确认的最近一条数据的 entry id。</li>
</ol>
<h2 id="BookKeeper-集群搭建"><a href="#BookKeeper-集群搭建" class="headerlink" title="BookKeeper 集群搭建"></a>BookKeeper 集群搭建</h2><p>关于 BookKeeper 集群的搭建可以参考 <a href="https://bookkeeper.apache.org/docs/4.8.0/deployment/manual/#starting-up-bookies" target="_blank" rel="external">Apache BookKeeper Manual deployment</a> 这篇文章。</p>
<h3 id="集群搭建前准备"><a href="#集群搭建前准备" class="headerlink" title="集群搭建前准备"></a>集群搭建前准备</h3><p>BookKeeper 集群搭建需要：</p>
<ol>
<li>ZooKeeper 集群；</li>
<li>一些 Bookie 节点（在集群的模式下最好是选取三台）；</li>
<li>JDK 版本要求是 JDK8；</li>
</ol>
<p>这里先看下 BookKeeper 的目录结构，跟其他分布式系统也类似，命令在 bin 目录下，配置文件在 conf 目录下，lib 是其依赖的相关 jar 包，如下所示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[matt@XXX2 bookkeeper]$ ll</span><br><span class="line">total 64</span><br><span class="line">drwxr-xr-x 2 matt matt  4096 Sep 20 18:35 bin</span><br><span class="line">drwxr-xr-x 2 matt matt  4096 Sep 20 18:35 conf</span><br><span class="line">drwxrwxr-x 9 matt matt  4096 Oct  9 21:41 deps</span><br><span class="line">drwxrwxr-x 2 matt matt 12288 Oct  9 21:41 lib</span><br><span class="line">-rw-r--r-- 1 matt matt 24184 Sep 20 18:35 LICENSE</span><br><span class="line">-rw-r--r-- 1 matt matt  5114 Sep 20 18:35 NOTICE</span><br><span class="line">-rw-r--r-- 1 matt matt  4267 Sep 20 18:35 README.md</span><br></pre></td></tr></table></figure>
<p>bin 目录下提供了 BookKeeper 相应的操作命令，这里用的命令主要是 <code>bin/bookkeeper*</code>（<code>bookkeeper-daemon.sh</code> 可以让 Bookie 进程在后台自动运行），可以在 <code>bin/common.sh</code> 配置一些通用的配置（比如 JAVA_HOME），关于 bookkeeper 命令的使用方法见 <a href="https://bookkeeper.apache.org/docs/4.8.0/reference/cli/#bookkeeper" target="_blank" rel="external">bookkeeper cli</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[matt@XXX2 bookkeeper]$ ll bin/</span><br><span class="line">total 56</span><br><span class="line">-rwxr-xr-x 1 matt matt 2319 Sep 20 18:35 bkctl</span><br><span class="line">-rwxr-xr-x 1 matt matt 5874 Sep 20 18:35 bookkeeper</span><br><span class="line">-rwxr-xr-x 1 matt matt 2869 Sep 20 18:35 bookkeeper-cluster.sh</span><br><span class="line">-rwxr-xr-x 1 matt matt 4590 Sep 20 18:35 bookkeeper-daemon.sh</span><br><span class="line">-rwxr-xr-x 1 matt matt 7785 Sep 20 18:35 common.sh</span><br><span class="line">-rwxr-xr-x 1 matt matt 4575 Sep 20 18:35 dlog</span><br><span class="line">-rwxr-xr-x 1 matt matt 1738 Sep 20 18:35 standalone</span><br><span class="line">-rwxr-xr-x 1 matt matt 5128 Sep 20 18:35 standalone.docker-compose</span><br><span class="line">-rwxr-xr-x 1 matt matt 1854 Sep 20 18:35 standalone.process</span><br></pre></td></tr></table></figure>
<p>在 bookkeper 命令中，又提供了 shell 的相关命令，这里提供的命令非常丰富，可以参考 <a href="https://bookkeeper.apache.org/docs/4.8.0/reference/cli/#the-bookkeeper-shell" target="_blank" rel="external">BookKeeper Shell</a>，如下所示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[matt@XXX2 bookkeeper]$ bin/bookkeeper shell</span><br><span class="line">Usage: bookkeeper shell [-localbookie [&lt;host:port&gt;]] [-ledgeridformat &lt;hex/long/uuid&gt;] [-entryformat &lt;hex/string&gt;] [-conf configuration] &lt;<span class="built_in">command</span>&gt;</span><br><span class="line"><span class="built_in">where</span> <span class="built_in">command</span> is one of:</span><br><span class="line">       autorecovery [-<span class="built_in">enable</span>|-<span class="built_in">disable</span>]</span><br><span class="line">       bookieformat [-nonInteractive] [-force] [-deleteCookie]</span><br><span class="line">       bookieinfo</span><br><span class="line">       bookiesanity [-entries N] [-timeout N]</span><br><span class="line">       convert-to-db-storage</span><br><span class="line">       convert-to-interleaved-storage</span><br><span class="line">       decommissionbookie [-bookieid &lt;bookieaddress&gt;]</span><br><span class="line">       deleteledger -ledgerid &lt;ledgerid&gt; [-force]</span><br><span class="line">       <span class="built_in">help</span>         [COMMAND]</span><br><span class="line">       initbookie</span><br><span class="line">       initnewcluster</span><br><span class="line">       lastmark</span><br><span class="line">       ledger       [-m] &lt;ledger_id&gt;</span><br><span class="line">       ledgermetadata -ledgerid &lt;ledgerid&gt;</span><br><span class="line">       listbookies  [-readwrite|-<span class="built_in">readonly</span>] [-hostnames]</span><br><span class="line">       listfilesondisc  [-journal|-entrylog|-index]</span><br><span class="line">       listledgers  [-meta] [-bookieid &lt;bookieaddress&gt;]</span><br><span class="line">       listunderreplicated [[-missingreplica &lt;bookieaddress&gt;] [-excludingmissingreplica &lt;bookieaddress&gt;]] [-printmissingreplica] [-printreplicationworkerid]</span><br><span class="line">       lostbookierecoverydelay [-get|-<span class="built_in">set</span> &lt;value&gt;]</span><br><span class="line">       metaformat   [-nonInteractive] [-force]</span><br><span class="line">       nukeexistingcluster -zkledgersrootpath &lt;zkledgersrootpath&gt; [-instanceid &lt;instanceid&gt; | -force]</span><br><span class="line">       readjournal [-dir] [-msg] &lt;journal_id | journal_file_name&gt;</span><br><span class="line">       readledger  [-bookie &lt;address:port&gt;]  [-msg] -ledgerid &lt;ledgerid&gt; [-firstentryid &lt;firstentryid&gt; [-lastentryid &lt;lastentryid&gt;]] [-force-recovery]</span><br><span class="line">       readlog      [-msg] &lt;entry_log_id | entry_log_file_name&gt; [-ledgerid &lt;ledgerid&gt; [-entryid &lt;entryid&gt;]] [-startpos &lt;startEntryLogBytePos&gt; [-endpos &lt;endEntryLogBytePos&gt;]]</span><br><span class="line">       readlogmetadata &lt;entry_log_id | entry_log_file_name&gt;</span><br><span class="line">       rebuild-db-ledger-locations-index</span><br><span class="line">       recover [-deleteCookie] &lt;bookieSrc[:bookieSrc]&gt;</span><br><span class="line">       simpletest   [-ensemble N] [-writeQuorum N] [-ackQuorum N] [-numEntries N]</span><br><span class="line">       triggeraudit</span><br><span class="line">       updatecookie [-bookieId &lt;hostname|ip&gt;] [-expandstorage] [-list] [-delete &lt;force&gt;]</span><br><span class="line">       updateledgers -bookieId &lt;hostname|ip&gt; [-updatespersec N] [-<span class="built_in">limit</span> N] [-verbose <span class="literal">true</span>/<span class="literal">false</span>] [-printprogress N]</span><br><span class="line">       whatisinstanceid</span><br><span class="line">       whoisauditor</span><br></pre></td></tr></table></figure>
<p>conf 目录下是关于 BookKeeper 的相关配置，如下所示，主要配置在 <code>bk_server.conf</code> 中，这里可以提供的配置非常多，具体可配置的参数可以参考 <a href="https://bookkeeper.apache.org/docs/4.8.0/reference/config/" target="_blank" rel="external">BookKeeper Config</a>，</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[matt@XXX2 bookkeeper]$ ll conf/</span><br><span class="line">total 84</span><br><span class="line">-rw-r--r-- 1 matt matt  1804 Sep 20 18:35 bk_cli_env.sh</span><br><span class="line">-rw-r--r-- 1 matt matt  2448 Sep 20 18:35 bkenv.sh</span><br><span class="line">-rwxr-xr-x 1 matt matt 42269 Sep 20 18:35 bk_server.conf</span><br><span class="line">-rw-r--r-- 1 matt matt  1211 Sep 20 18:35 jaas_example.conf</span><br><span class="line">-rw-r--r-- 1 matt matt  2311 Sep 20 18:35 log4j.cli.properties</span><br><span class="line">-rw-r--r-- 1 matt matt  2881 Sep 20 18:35 log4j.properties</span><br><span class="line">-rw-r--r-- 1 matt matt  1810 Sep 20 18:35 log4j.shell.properties</span><br><span class="line">-rw-r--r-- 1 matt matt  1117 Sep 20 18:35 nettyenv.sh</span><br><span class="line">-rwxr-xr-x 1 matt matt  1300 Sep 20 18:35 standalone.conf</span><br><span class="line">-rw-r--r-- 1 matt matt  3275 Sep 20 18:35 zookeeper.conf</span><br><span class="line">-rw-r--r-- 1 matt matt   843 Sep 20 18:35 zookeeper.conf.dynamic</span><br></pre></td></tr></table></figure>
<h3 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h3><p>在 <a href="https://bookkeeper.apache.org/releases/" target="_blank" rel="external">Apache BookKeeper Releases</a> 中下载 BookKeeper 最新的安装包（这里以 bookkeeper-server-4.8.0-bin.tar.gz 为例）。</p>
<p>将安装包在指定目录下解压后，启动的操作分为以下几步：</p>
<ol>
<li>修改相关配置（<code>zkServers</code>、<code>bookiePort</code>、<code>journalDir</code>、<code>ledgerDir</code> 等）；</li>
<li>在相应的机器上启动 Bookie 进程（使用 <code>./bin/bookkeeper-daemon.sh start bookie</code> 启动 Bookie）；</li>
<li>当所有的 Bookie 启动完成后，随便选择一台，初始化集群 meta 信息（使用 <code>bookkeeper-server/bin/bookkeeper shell metaformat</code> 命令初始化集群的 meta 信息，这里只需要初始化一次）。</li>
</ol>
<p>如果启动成功的话（如果有异常日志，即使 Bookie 进程存在，也可能没有启动成功），启动正常的情况下，在日志中，可以看到类似下面的信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2018-10-15 11:24:49,549 - INFO  [main:ComponentStarter@81] - Started component bookie-server.</span><br></pre></td></tr></table></figure>
<h3 id="Admin-REST-API"><a href="#Admin-REST-API" class="headerlink" title="Admin REST API"></a>Admin REST API</h3><p>BookKeeper 服务提供了相应的 Rest API，可供管理员使用，具体可以参考 <a href="https://bookkeeper.apache.org/docs/4.8.0/admin/http/" target="_blank" rel="external">BookKeeper Admin REST API</a>，如果想要使用这个功能，首先需要 Bookie 服务将 bk_server.conf 中的 <code>httpServerEnabled</code> 配置设置为 true ，相关的配置参考 <a href="https://bookkeeper.apache.org/docs/4.8.0/reference/config/#http-server-settings" target="_blank" rel="external">Http server settings</a>。</p>
<h3 id="安装时踩的坑"><a href="#安装时踩的坑" class="headerlink" title="安装时踩的坑"></a>安装时踩的坑</h3><p>在搭建 BookKeeper 集群中，并没有想象中那么顺畅，遇到了一些小问题，记录如下：</p>
<h4 id="问题1：修改配置后重新启动失败"><a href="#问题1：修改配置后重新启动失败" class="headerlink" title="问题1：修改配置后重新启动失败"></a>问题1：修改配置后重新启动失败</h4><p>在使用  <code>./bin/bookkeeper-daemon.sh  stop bookie</code> 命令关闭 Bookie 进程，当关闭完 Bookie 进程后，再次启动时，发现无法启动，报出了下面的错误：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">2018-10-13 21:05:40,674 - ERROR [main:Main@221] - Failed to build bookie server</span><br><span class="line">org.apache.bookkeeper.bookie.BookieException<span class="variable">$InvalidCookieException</span>: instanceId 406a08e5-911e-4ab6-b97b-40e4a56279a8 is not matching with null</span><br><span class="line">	at org.apache.bookkeeper.bookie.Cookie.verifyInternal(Cookie.java:142)</span><br><span class="line">	at org.apache.bookkeeper.bookie.Cookie.verify(Cookie.java:147)</span><br><span class="line">	at org.apache.bookkeeper.bookie.Bookie.verifyAndGetMissingDirs(Bookie.java:381)</span><br><span class="line">	at org.apache.bookkeeper.bookie.Bookie.checkEnvironmentWithStorageExpansion(Bookie.java:444)</span><br><span class="line">	at org.apache.bookkeeper.bookie.Bookie.checkEnvironment(Bookie.java:262)</span><br><span class="line">	at org.apache.bookkeeper.bookie.Bookie.&lt;init&gt;(Bookie.java:646)</span><br><span class="line">	at org.apache.bookkeeper.proto.BookieServer.newBookie(BookieServer.java:133)</span><br><span class="line">	at org.apache.bookkeeper.proto.BookieServer.&lt;init&gt;(BookieServer.java:102)</span><br><span class="line">	at org.apache.bookkeeper.server.service.BookieService.&lt;init&gt;(BookieService.java:43)</span><br><span class="line">	at org.apache.bookkeeper.server.Main.buildBookieServer(Main.java:299)</span><br><span class="line">	at org.apache.bookkeeper.server.Main.doMain(Main.java:219)</span><br><span class="line">	at org.apache.bookkeeper.server.Main.main(Main.java:201)</span><br></pre></td></tr></table></figure>
<p>大概的意思就是说现在 zk 上的 instanceId 是 <code>406a08e5-911e-4ab6-b97b-40e4a56279a8</code>，而期望的 instanceId 是 null，索引因为验证失败导致进程无法启动，instanceId 是搭建集群第三步（初始化集群 meta 信息的地方）中初始化的。此时如果我们启动测试的 client 程序，会抛出以下异常，这是因为目前集群只有2台 Bookie 处在可用状态，而 ensSize 默认是 3，writeQuorumSize 是 2，ackQuorumSize 是2。在 client 的测试程序中，新建一个 Ledger 时，由于集群当前可用的 Bookie 为2，不满足相应的条件，所以抛出了一下的异常：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">org.apache.bookkeeper.client.BKException<span class="variable">$BKNotEnoughBookiesException</span>: Not enough non-faulty bookies available</span><br><span class="line">	at org.apache.bookkeeper.client.SyncCallbackUtils.finish(SyncCallbackUtils.java:83)</span><br><span class="line">	at org.apache.bookkeeper.client.SyncCallbackUtils<span class="variable">$SyncCreateCallback</span>.createComplete(SyncCallbackUtils.java:106)</span><br><span class="line">	at org.apache.bookkeeper.client.LedgerCreateOp.createComplete(LedgerCreateOp.java:238)</span><br><span class="line">	at org.apache.bookkeeper.client.LedgerCreateOp.initiate(LedgerCreateOp.java:142)</span><br><span class="line">	at org.apache.bookkeeper.client.BookKeeper.asyncCreateLedger(BookKeeper.java:891)</span><br><span class="line">	at org.apache.bookkeeper.client.BookKeeper.createLedger(BookKeeper.java:975)</span><br><span class="line">	at org.apache.bookkeeper.client.BookKeeper.createLedger(BookKeeper.java:930)</span><br><span class="line">	at org.apache.bookkeeper.client.BookKeeper.createLedger(BookKeeper.java:911)</span><br><span class="line">	at com.matt.test.bookkeeper.ledger.LedgerTest.createLedgerSync(LedgerTest.java:110)</span><br><span class="line">	at com.matt.test.bookkeeper.ledger.LedgerTest.main(LedgerTest.java:25)</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.NullPointerException</span><br><span class="line">	at com.matt.test.bookkeeper.ledger.LedgerTest.main(LedgerTest.java:26)</span><br></pre></td></tr></table></figure>
<p>关于这个 BookieException$InvalidCookieException 异常，google 了一下并没有找到相应的解决办法，所以就直接看了相应的代码，抛出异常的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">verifyInternal</span><span class="params">(Cookie c, <span class="keyword">boolean</span> checkIfSuperSet)</span> <span class="keyword">throws</span> BookieException.InvalidCookieException </span>&#123;</span><br><span class="line">    String errMsg;</span><br><span class="line">    <span class="keyword">if</span> (c.layoutVersion &lt; <span class="number">3</span> &amp;&amp; c.layoutVersion != layoutVersion) &#123;</span><br><span class="line">        errMsg = <span class="string">"Cookie is of too old version "</span> + c.layoutVersion;</span><br><span class="line">        LOG.error(errMsg);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BookieException.InvalidCookieException(errMsg);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(c.layoutVersion &gt;= <span class="number">3</span> &amp;&amp; c.bookieHost.equals(bookieHost)</span><br><span class="line">        &amp;&amp; c.journalDirs.equals(journalDirs) &amp;&amp; verifyLedgerDirs(c, checkIfSuperSet))) &#123;</span><br><span class="line">        errMsg = <span class="string">"Cookie ["</span> + <span class="keyword">this</span> + <span class="string">"] is not matching with ["</span> + c + <span class="string">"]"</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BookieException.InvalidCookieException(errMsg);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((instanceId == <span class="keyword">null</span> &amp;&amp; c.instanceId != <span class="keyword">null</span>)</span><br><span class="line">            || (instanceId != <span class="keyword">null</span> &amp;&amp; !instanceId.equals(c.instanceId))) &#123;</span><br><span class="line">        <span class="comment">// instanceId should be same in both cookies</span></span><br><span class="line">        errMsg = <span class="string">"instanceId "</span> + instanceId</span><br><span class="line">                + <span class="string">" is not matching with "</span> + c.instanceId;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BookieException.InvalidCookieException(errMsg); <span class="comment">// 由于 instanceId 不匹配，抛出了相应的异常</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里可以看到的是从 zk 上拿到的 instanceId 是 <code>406a08e5-911e-4ab6-b97b-40e4a56279a8</code>，而 Cookie 实例 c 中的 instanceId 为 null，那么 这个 Cookie 是如何初始化的呢？往上追一下代码，发现是在初始化 Bookie 时，会检查一下相应的运行环境，此时会从 journalDirectories 和 ledgerDirectories 中 <code>current/VERSION</code> 中初始化相应的 Cookie 对象，由于这个台机器之前启动过，所以这个文件已经创建了，文件的内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[matt@XXX2 bookkeeper]$ cat /tmp/bk-data/current/VERSION</span><br><span class="line">4</span><br><span class="line">bookieHost: &quot;XXX:3181&quot;</span><br><span class="line">journalDir: &quot;/tmp/bk-txn&quot;</span><br><span class="line">ledgerDirs: &quot;1\t/tmp/bk-data&quot;</span><br><span class="line">[matt@XXX2 bookkeeper]$ cat /tmp/bk-txn/current/VERSION</span><br><span class="line">4</span><br><span class="line">bookieHost: &quot;XXX:3181&quot;</span><br><span class="line">journalDir: &quot;/tmp/bk-txn&quot;</span><br><span class="line">ledgerDirs: &quot;1\t/tmp/bk-data&quot;</span><br></pre></td></tr></table></figure>
<p>Cookie 从文件加载相应文件，并初始化对象的实现方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Read cookie from registration manager for a given bookie &lt;i&gt;address&lt;/i&gt;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rm registration manager</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> address bookie address</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> versioned cookie object</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BookieException when fail to read cookie</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Versioned&lt;Cookie&gt; <span class="title">readFromRegistrationManager</span><span class="params">(RegistrationManager rm,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                     BookieSocketAddress address)</span> <span class="keyword">throws</span> BookieException </span>&#123;</span><br><span class="line">    Versioned&lt;<span class="keyword">byte</span>[]&gt; cookieData = rm.readCookie(address.toString());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (BufferedReader reader = <span class="keyword">new</span> BufferedReader(</span><br><span class="line">                <span class="keyword">new</span> StringReader(<span class="keyword">new</span> String(cookieData.getValue(), UTF_8)))) &#123;</span><br><span class="line">            Builder builder = parse(reader);</span><br><span class="line">            Cookie cookie = builder.build();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Versioned&lt;Cookie&gt;(cookie, cookieData.getVersion());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidCookieException(ioe);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Builder <span class="title">parse</span><span class="params">(BufferedReader reader)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Builder cBuilder = Cookie.newBuilder();</span><br><span class="line">    <span class="keyword">int</span> layoutVersion = <span class="number">0</span>;</span><br><span class="line">    String line = reader.readLine();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == line) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> EOFException(<span class="string">"Exception in parsing cookie"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        layoutVersion = Integer.parseInt(line.trim());</span><br><span class="line">        cBuilder.setLayoutVersion(layoutVersion);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Invalid string '"</span> + line.trim()</span><br><span class="line">                + <span class="string">"', cannot parse cookie."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (layoutVersion == <span class="number">3</span>) &#123;</span><br><span class="line">        cBuilder.setBookieHost(reader.readLine());</span><br><span class="line">        cBuilder.setJournalDirs(reader.readLine());</span><br><span class="line">        cBuilder.setLedgerDirs(reader.readLine());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (layoutVersion &gt;= <span class="number">4</span>) &#123; <span class="comment">//这里的版本默认为 4</span></span><br><span class="line">        CookieFormat.Builder cfBuilder = CookieFormat.newBuilder();</span><br><span class="line">        TextFormat.merge(reader, cfBuilder);</span><br><span class="line">        CookieFormat data = cfBuilder.build();</span><br><span class="line">        cBuilder.setBookieHost(data.getBookieHost());</span><br><span class="line">        cBuilder.setJournalDirs(data.getJournalDir());</span><br><span class="line">        cBuilder.setLedgerDirs(data.getLedgerDirs());</span><br><span class="line">        <span class="comment">// Since InstanceId is optional</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != data.getInstanceId() &amp;&amp; !data.getInstanceId().isEmpty()) &#123; <span class="comment">//如果文件中没有 instanceId 字段，这里就不会初始化到 Cookie 中</span></span><br><span class="line">            cBuilder.setInstanceId(data.getInstanceId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cBuilder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解决的方法很简单，在 <code>current/VERSION</code> 文件中添加相应的 instanceId 字段后，Bookie 便可启动成功。但是这里还需要考虑的问题是：</p>
<ul>
<li>instanceId 在这里的作用是什么？instanceId 是在集群初始化时设置的，关于这个值的含义，我推测它的目的是对节点的上线做一个简单的认证，也就是说如果打算在集群中新添加一台 Bookie，需要知道当前的 instanceId 值，这样才能加入到这个集群中；</li>
<li>Bookie 服务的启动流程是什么样的？这里就需要看下代码的具体实现，追一下 Bookie 的启动流程了。</li>
</ul>
<h2 id="BookKeeper-API-使用"><a href="#BookKeeper-API-使用" class="headerlink" title="BookKeeper API 使用"></a>BookKeeper API 使用</h2><p>关于 BookKeeper API，总共提供了以下三种 API：</p>
<ol>
<li>The ledger API is a lower-level API that enables you to interact with ledgers directly，第一种是一种较为底层的 API 接口，直接与 Ledger 交互，见 <a href="https://bookkeeper.apache.org/docs/4.8.0/api/ledger-api/" target="_blank" rel="external">The Ledger API</a>；</li>
<li>The Ledger Advanced API is an advanced extension to Ledger API to provide more flexibilities to applications，第二种较高级的 API，提供了一些较高级的功能，见 <a href="https://bookkeeper.apache.org/docs/4.8.0/api/ledger-adv-apiThe Advanced Ledger API/" target="_blank" rel="external">The Advanced Ledger API</a>；</li>
<li>The DistributedLog API is a higher-level API that provides convenient abstractions，这种是关于 DistributedLog 的一些操作 API，见 <a href="https://bookkeeper.apache.org/docs/4.8.0/api/distributedlog-api/" target="_blank" rel="external">DistributedLog</a>。</li>
</ol>
<p>在这节，我们主要看下第一种的实现，会简单讲述一下第二种，第三种这里不再介绍。</p>
<h3 id="The-Ledger-API"><a href="#The-Ledger-API" class="headerlink" title="The Ledger API"></a>The Ledger API</h3><p>关于 Ledger API 基本操作主要有以下几种：</p>
<ol>
<li>创建 Ledger；</li>
<li>向 Ledger 写入数据（Entry）；</li>
<li>关闭 Ledger，Ledger 关闭后数据就不能再写入，Ledger 一旦关闭它的数据就是不可变的；</li>
<li>从 Ledger 中读取数据；</li>
<li>删除 Ledger。</li>
</ol>
<p>当然实现上述操作的前提是，需要先初始化一个 BookKeeper Client，下面开始慢慢讲述。</p>
<h4 id="初始化-BookKeeper-Client"><a href="#初始化-BookKeeper-Client" class="headerlink" title="初始化 BookKeeper Client"></a>初始化 BookKeeper Client</h4><p>BK Client 的初始化需要指定 zk 地址，BK Client 通过 zk 来连接到 BK 集群，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一种初始化 BookKeeper Client 的方法</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    String connectionString = zkAddr; <span class="comment">// For a single-node, local ZooKeeper cluster</span></span><br><span class="line">    BookKeeper bkClient = <span class="keyword">new</span> BookKeeper(connectionString);</span><br><span class="line">    logger.info(<span class="string">"BookKeeper client init success."</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException | IOException | BKException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">            <span class="string">"There is an exception throw while creating the BookKeeper client."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二种初始化 BookKeeper Client 的方法</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ClientConfiguration config = <span class="keyword">new</span> ClientConfiguration();</span><br><span class="line">    config.setZkServers(zkAddr);</span><br><span class="line">    config.setAddEntryTimeout(<span class="number">2000</span>);</span><br><span class="line">    BookKeeper bkClient = <span class="keyword">new</span> BookKeeper(config);</span><br><span class="line">    logger.info(<span class="string">"BookKeeper client init success."</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException | IOException | BKException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">            <span class="string">"There is an exception throw while creating the BookKeeper client."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="新建一个-Ledger"><a href="#新建一个-Ledger" class="headerlink" title="新建一个 Ledger"></a>新建一个 Ledger</h4><p>Ledger 的创建有两种，一种是同步创建，一种是异步创建（创建时需要指定相应的 password），其实现分别如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * create the ledger, default ensemble size is 3, write quorum size is 2, ack quorum size is 2</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pw password</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> LedgerHandle</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LedgerHandle <span class="title">createLedgerSync</span><span class="params">(String pw)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] password = pw.getBytes();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        LedgerHandle handle = bkClient.createLedger(BookKeeper.DigestType.MAC, password);</span><br><span class="line">        <span class="keyword">return</span> handle;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BKException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * create the ledger</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pw password</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createLedgerAsync</span><span class="params">(String pw)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">LedgerCreationCallback</span> <span class="keyword">implements</span> <span class="title">AsyncCallback</span>.<span class="title">CreateCallback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createComplete</span><span class="params">(<span class="keyword">int</span> returnCode, LedgerHandle handle, Object ctx)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Ledger successfully created"</span>);</span><br><span class="line">            logger.info(<span class="string">"Ledger successfully created async."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bkClient.asyncCreateLedger(</span><br><span class="line">            <span class="number">3</span>, <span class="comment">// ensSize</span></span><br><span class="line">            <span class="number">2</span>, <span class="comment">// writeQuorumSize and ackQuorumSize</span></span><br><span class="line">            BookKeeper.DigestType.MAC,</span><br><span class="line">            pw.getBytes(),</span><br><span class="line">            <span class="keyword">new</span> LedgerCreationCallback(),</span><br><span class="line">            <span class="string">"some context"</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建好 Ledger 之后，会返回一个 LedgerHandle 实例，对于 Ledger 的操作都是通过这个实例对象完成的，也可以通过 <code>LedgerHandle.getId()</code> 方法获取 Ledger 的 id，有了这个 id 就可以映射到具体的 Ledger，当需要读取数据时，通过 ledger id 初始化相应的 LedgerHandle 实例即可。</p>
<h4 id="向-Ledger-写入数据"><a href="#向-Ledger-写入数据" class="headerlink" title="向 Ledger 写入数据"></a>向 Ledger 写入数据</h4><p>有了 Ledger 对应的 LedgerHandle 实例之后，可以通过 <code>addEntry()</code> 方法直接向 Ledger 写数据，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">addEntry</span><span class="params">(LedgerHandle ledgerHandle, String msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ledgerHandle.addEntry(msg.getBytes());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BKException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="从-Ledger-读取数据"><a href="#从-Ledger-读取数据" class="headerlink" title="从 Ledger 读取数据"></a>从 Ledger 读取数据</h4><p>从 Ledger 读取数据时，也是通过 LedgerHandle 实例的方法实现，提供了以下三种方法：</p>
<ol>
<li>指定读取的 entry.id 范围消费；</li>
<li>从某一个 entry.id 一直读取到 LAC （LastAddConfirmed，该 Ledger 中最近的已经确认的数据）位置；</li>
<li>从某一个 entry.id 一直读取到 lastEntryIdExpectedToRead 位置，该位置可以比 LAC 大，前提是需要该值已经有对应的数据；</li>
</ol>
<p>方法实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * read entry from startId to endId</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ledgerHandle the ledger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> startId      start entry id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> endId        end entry id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the entries, if occur exception, return null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Enumeration&lt;LedgerEntry&gt; <span class="title">readEntry</span><span class="params">(LedgerHandle ledgerHandle, <span class="keyword">int</span> startId, <span class="keyword">int</span> endId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ledgerHandle.readEntries(startId, endId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BKException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * read entry from 0 to the LAC</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ledgerHandle the ledger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the entries, if occur exception, return null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Enumeration&lt;LedgerEntry&gt; <span class="title">readEntry</span><span class="params">(LedgerHandle ledgerHandle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ledgerHandle.readEntries(<span class="number">0</span>, ledgerHandle.getLastAddConfirmed());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BKException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * read entry form 0 to lastEntryIdExpectedToRead which can larger than the LastAddConfirmed range</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ledgerHandle              the handle</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> lastEntryIdExpectedToRead the last entry id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the entries, if occur exception, return null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Enumeration&lt;LedgerEntry&gt; <span class="title">readEntry</span><span class="params">(LedgerHandle ledgerHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          <span class="keyword">long</span> lastEntryIdExpectedToRead)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ledgerHandle.readUnconfirmedEntries(<span class="number">0</span>, lastEntryIdExpectedToRead);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BKException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="删除-Ledger"><a href="#删除-Ledger" class="headerlink" title="删除 Ledger"></a>删除 Ledger</h4><p>Ledger 的删除实现也很简洁，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * delete the ledger</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ledgerId the ledger id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> if occur exception, return false</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteLedger</span><span class="params">(<span class="keyword">long</span> ledgerId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        bkClient.deleteLedger(ledgerId);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="The-Ledger-Advanced-API"><a href="#The-Ledger-Advanced-API" class="headerlink" title="The Ledger Advanced API"></a>The Ledger Advanced API</h3><p>Ledger 的 Advanced API 在用法上与上面的实现差异不大，它向应用提供了更大的灵活性，比如：在创建 Ledger 时，应用可以指定 LedgerId，写入 Entry 时，应用也可以指定相应的 EntryID。</p>
<h4 id="新建-Ledger"><a href="#新建-Ledger" class="headerlink" title="新建 Ledger"></a>新建 Ledger</h4><p>在新建 Ledger 这部分，Advanced API 可以指定 LedgerId 创建相应的 Ledger，如下面示例的第三种实现。</p>
<p>假设当前 BK 集群的 LedgerId 已经到了5，这时候在新建 Ledger 时如果不指定 LedgerId，下一个被使用的 LedgerId 就是6，如果应用指定了 7，新建的 Leader 的 id 将会是设置的 7，id 6 会等待下次再被使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * create the ledger</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> password pw</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> LedgerHandleAdv</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LedgerHandleAdv <span class="title">createLedger</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] passwd = password.getBytes();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        LedgerHandleAdv handle = (LedgerHandleAdv) bkClient.createLedgerAdv(</span><br><span class="line">                <span class="number">3</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="comment">// replica settings</span></span><br><span class="line">                BookKeeper.DigestType.CRC32,</span><br><span class="line">                passwd);</span><br><span class="line">        <span class="keyword">return</span> handle;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BKException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * create the ledger async</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createLedgerAsync</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">LedgerCreationCallback</span> <span class="keyword">implements</span> <span class="title">AsyncCallback</span>.<span class="title">CreateCallback</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createComplete</span><span class="params">(<span class="keyword">int</span> returnCode, LedgerHandle handle, Object ctx)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Ledger successfully created"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    bkClient.asyncCreateLedgerAdv(</span><br><span class="line">            <span class="number">3</span>, <span class="comment">// ensemble size</span></span><br><span class="line">            <span class="number">3</span>, <span class="comment">// write quorum size</span></span><br><span class="line">            <span class="number">2</span>, <span class="comment">// ack quorum size</span></span><br><span class="line">            BookKeeper.DigestType.CRC32,</span><br><span class="line">            password.getBytes(),</span><br><span class="line">            <span class="keyword">new</span> LedgerCreationCallback(),</span><br><span class="line">            <span class="string">"some context"</span>,</span><br><span class="line">            <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * create the ledger on special ledgerId</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> password pw</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ledgerId the ledger id, if the ledger id exist, it will return BKLedgerExistException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> LedgerHandleAdv</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LedgerHandleAdv <span class="title">createLedger</span><span class="params">(String password, <span class="keyword">long</span> ledgerId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] passwd = password.getBytes();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        LedgerHandleAdv handle = (LedgerHandleAdv) bkClient.createLedgerAdv(</span><br><span class="line">                ledgerId,</span><br><span class="line">                <span class="number">3</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="comment">// replica settings</span></span><br><span class="line">                BookKeeper.DigestType.CRC32,</span><br><span class="line">                passwd,</span><br><span class="line">                <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> handle;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BKException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="向-Ledger-添加-Entry"><a href="#向-Ledger-添加-Entry" class="headerlink" title="向 Ledger 添加 Entry"></a>向 Ledger 添加 Entry</h4><p>向 Ledger 添加 Entry API 中，最吸引我的是可以指定 EntryId 写入（熟悉 Kafka 的同学知道，向 Kafka 写入数据是可以指定 Partition，但是不能指定 offset，如果可以指定 offset 写入，那么在做容灾时就可以实现 topic 的完全同步，下游可以根据 commit offset 随时切换数据源），其示例如下（注意，Advanced API 在写数据时是强制要指定 entryId 的）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * add the msg to the ledger on the special entryId</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ledgerHandleAdv ledgerHandleAdv</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> entryId         the entry id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> msg             msg</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(LedgerHandleAdv ledgerHandleAdv, <span class="keyword">long</span> entryId, String msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ledgerHandleAdv.addEntry(entryId, msg.getBytes());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BKException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于这个 API，社区官方文档有如下介绍：</p>
<ol>
<li>The entry id has to be non-negative.</li>
<li>Clients are okay to add entries out of order.</li>
<li>However, the entries are only acknowledged in a monotonic order starting from 0.</li>
</ol>
<p>首先，说下我对上面的理解：entry.id 要求是非负的，client 在添加 entry 时可以乱序，但是 entry 只有 0 开始单调顺序增加时才会被 ack。最开始，我以为是只要 entry.id 单调递增就可以，跑了一个测试用例，第一个 entry 的 id 设置为 0，第二个设置为 2，然后程序直接 hang 在那里了，相应日志信息为：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">2018-10-19 16:58:34  [ BookKeeperClientWorker-OrderedExecutor-0-0:662 ] - [ DEBUG ]  Got Add response from bookie:XXX.230:3181 rc:EOK, ledger:8:entry:0</span><br><span class="line">2018-10-19 16:58:34  [ BookKeeperClientWorker-OrderedExecutor-0-0:663 ] - [ DEBUG ]  Got Add response from bookie:XXX.247:3181 rc:EOK, ledger:8:entry:0</span><br><span class="line">2018-10-19 16:58:34  [ BookKeeperClientWorker-OrderedExecutor-0-0:663 ] - [ DEBUG ]  Submit callback (lid:8, eid: 0). rc:0</span><br><span class="line">2018-10-19 16:58:34  [ main:663 ] - [ DEBUG ]  Adding entry [50, 32, 109, 97, 116, 116, 32, 116, 101, 115, 116]</span><br><span class="line">2018-10-19 16:58:34  [ BookKeeperClientWorker-OrderedExecutor-0-0:673 ] - [ DEBUG ]  Got Add response from bookie:XXX.247:3181 rc:EOK, ledger:8:entry:2</span><br><span class="line">2018-10-19 16:58:34  [ BookKeeperClientWorker-OrderedExecutor-0-0:673 ] - [ DEBUG ]  Got Add response from bookie:XXX.230:3181 rc:EOK, ledger:8:entry:2</span><br><span class="line">2018-10-19 16:58:34  [ BookKeeperClientWorker-OrderedExecutor-0-0:673 ] - [ DEBUG ]  Head of the queue entryId: 2 is not the expected value: 1</span><br><span class="line">2018-10-19 16:58:34  [ BookKeeperClientWorker-OrderedExecutor-0-0:673 ] - [ DEBUG ]  Got Add response from bookie:XXX.146:3181 rc:EOK, ledger:8:entry:0</span><br><span class="line">2018-10-19 16:58:34  [ BookKeeperClientWorker-OrderedExecutor-0-0:673 ] - [ DEBUG ]  Head of the queue entryId: 2 is not the expected value: 1</span><br><span class="line">2018-10-19 16:58:34  [ BookKeeperClientWorker-OrderedExecutor-0-0:681 ] - [ DEBUG ]  Got Add response from bookie:XXX.146:3181 rc:EOK, ledger:8:entry:2</span><br><span class="line">2018-10-19 16:58:34  [ BookKeeperClientWorker-OrderedExecutor-0-0:681 ] - [ DEBUG ]  Head of the queue entryId: 2 is not the expected value: 1</span><br><span class="line">2018-10-19 16:58:37  [ main-SendThread(zk01:2181):3702 ] - [ DEBUG ]  Got ping response <span class="keyword">for</span> sessionid: 0x3637dbff9e7486c after 0ms</span><br><span class="line">2018-10-19 16:58:40  [ main-SendThread(zk01:2181):7039 ] - [ DEBUG ]  Got ping response <span class="keyword">for</span> sessionid: 0x3637dbff9e7486c after 0ms</span><br><span class="line">2018-10-19 16:58:43  [ main-SendThread(zk01:2181):10374 ] - [ DEBUG ]  Got ping response <span class="keyword">for</span> sessionid: 0x3637dbff9e7486c after 0ms</span><br><span class="line">2018-10-19 16:58:47  [ main-SendThread(zk01:2181):13710 ] - [ DEBUG ]  Got ping response <span class="keyword">for</span> sessionid: 0x3637dbff9e7486c after 0ms</span><br><span class="line">2018-10-19 16:58:50  [ main-SendThread(zk01:2181):17043 ] - [ DEBUG ]  Got ping response <span class="keyword">for</span> sessionid: 0x3637dbff9e7486c after 0ms</span><br></pre></td></tr></table></figure>
<p>可以看到有这样的异常日志 <code>Head of the queue entryId: 2 is not the expected value: 1</code>，期望的 entry id 是 1，这里是 2，乱序了，导致程序直接 hang 住（hang 住的原因推测是这个 Entry 没有被 ack），该异常信息出现地方如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendAddSuccessCallbacks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Start from the head of the queue and proceed while there are</span></span><br><span class="line">    <span class="comment">// entries that have had all their responses come back</span></span><br><span class="line">    PendingAddOp pendingAddOp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((pendingAddOp = pendingAddOps.peek()) != <span class="keyword">null</span></span><br><span class="line">           &amp;&amp; blockAddCompletions.get() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!pendingAddOp.completed) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                LOG.debug(<span class="string">"pending add not completed: &#123;&#125;"</span>, pendingAddOp);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Check if it is the next entry in the sequence.</span></span><br><span class="line">        <span class="keyword">if</span> (pendingAddOp.entryId != <span class="number">0</span> &amp;&amp; pendingAddOp.entryId != pendingAddsSequenceHead + <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                LOG.debug(<span class="string">"Head of the queue entryId: &#123;&#125; is not the expected value: &#123;&#125;"</span>, pendingAddOp.entryId,</span><br><span class="line">                           pendingAddsSequenceHead + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pendingAddOps.remove();</span><br><span class="line">        explicitLacFlushPolicy.updatePiggyBackedLac(lastAddConfirmed);</span><br><span class="line">        pendingAddsSequenceHead = pendingAddOp.entryId;</span><br><span class="line">        <span class="keyword">if</span> (!writeFlags.contains(WriteFlag.DEFERRED_SYNC)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.lastAddConfirmed = pendingAddsSequenceHead;</span><br><span class="line">        &#125;</span><br><span class="line">        pendingAddOp.submitCallback(BKException.Code.OK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 entry id 出现了乱序，会导致这个 add 操作没有正常处理。但是如果这里强制要求 entry.id 从 0，而还有序，那么这个 API 跟前面的 API 有什么区别？这点没有搞懂，也向社区发一封邮件咨询，还在等待社区的响应。</p>
</div><div class="copyright"><h2 id="版权说明"><a href="#版权说明" title="版权说明" class="headerlink">版权说明</a></h2><p><strong><big><a href="http://matt33.com/copyright/">博客版权说明</a></big></strong></p><p>所有文章以 <strong><a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="external">知识共享署名 4.0 国际许可协议 </a></strong>进行授权，转载时请注明原文链接</p></div><div class="weixin"><h2 id="公众号"><a href="#公众号" title="公众号" class="headerlink">公众号</a></h2><p>个人公众号（柳年思水）已经上线，最新文章会同步在公众号发布，欢迎大家关注~</p><p></p><p><img src="/images/wangm92-3.png" style="text-align:center" width="600"></p></div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://matt33.com/2018/10/19/bk-cluster-install-and-use/" data-id="ckdcxwqvl00akj4cbz07ioavo" class="article-share-link">分享到</a><div class="tags"><a href="/tags/bk/">bk</a></div><div class="post-nav"><a href="/2018/10/24/kafka-idempotent/" class="pre">Kafka 事务性之幂等性实现</a><a href="/2018/09/01/yarn-architecture-learn/" class="next">YARN 架构学习总结</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'http-matt33-com';
var disqus_identifier = '2018/10/19/bk-cluster-install-and-use/';
var disqus_title = 'BookKeeper 集群搭建及使用';
var disqus_url = 'http://matt33.com/2018/10/19/bk-cluster-install-and-use/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/favicon.ico',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//http-matt33-com.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-weibo"> 微博</i></div><iframe width="100%" height="90" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=100&fansRow=1&ptype=1&speed=0&skin=1&isTitle=0&noborder=1&isWeibo=0&isFans=0&uid=2650396571&verifier=f2f0e397&colors=D8D8D8,ffffff,666666,0082cb,ecfbfd&dpc=1"></iframe></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/书屋/">书屋</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/影如人生/">影如人生</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/旅行/">旅行</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/转载/">转载</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/电影随想/" style="font-size: 15px;">电影随想</a> <a href="/tags/思考/" style="font-size: 15px;">思考</a> <a href="/tags/database/" style="font-size: 15px;">database</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/storm/" style="font-size: 15px;">storm</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/learn/" style="font-size: 15px;">learn</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/bug/" style="font-size: 15px;">bug</a> <a href="/tags/cv/" style="font-size: 15px;">cv</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/travel/" style="font-size: 15px;">travel</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/paper/" style="font-size: 15px;">paper</a> <a href="/tags/flink/" style="font-size: 15px;">flink</a> <a href="/tags/system/" style="font-size: 15px;">system</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/转载/" style="font-size: 15px;">转载</a> <a href="/tags/algorithm/" style="font-size: 15px;">algorithm</a> <a href="/tags/jvm/" style="font-size: 15px;">jvm</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/分布式系统/" style="font-size: 15px;">分布式系统</a> <a href="/tags/bk/" style="font-size: 15px;">bk</a> <a href="/tags/rpc/" style="font-size: 15px;">rpc</a> <a href="/tags/thrift/" style="font-size: 15px;">thrift</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/calcite/" style="font-size: 15px;">calcite</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/08/02/kubernetes-start/">Kubenetes 之新手入门篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/16/cpu-branch-predictor/">浅谈 CPU 分支预测技术</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/20/flink-task-mailbox/">Flink 基于 MailBox 实现的 StreamTask 线程模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/15/flink-taskmanager-7/">Flink TaskManager 详解（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/27/flink-jobmanager-6/">Flink JobManager 详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/23/flink-master-5/">Flink Master 详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/20/flink-execution-graph-4/">Flink 如何生成 ExecutionGraph</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/09/flink-job-graph-3/">Flink Streaming 作业如何转化为 JobGraph</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/08/flink-stream-graph-2/">Flink DataStream API 概述及作业如何转换为 StreamGraph</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/23/flink-learn-start-1/">Apache Flink 初探</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://matt33.com/about/" title="个人公众号：柳年思水" target="_blank">个人公众号：柳年思水</a><ul></ul><a href="http://tech.meituan.com/" title="美团点评技术团队" target="_blank">美团点评技术团队</a><ul></ul><a href="http://jm.taobao.org/" title="阿里中间件团队博客" target="_blank">阿里中间件团队博客</a><ul></ul><a href="http://www.jianshu.com/" title="简书" target="_blank">简书</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Matt's Blog 柳年思水.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><div class="analytics"><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cspan id='cnzz_stat_icon_1256517224'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1256517224%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script></div><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-64518924-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?5cf44757fa0d23bc7637935e44a9104a";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>